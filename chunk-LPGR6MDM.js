import"./chunk-PSYSN2XC.js";import{a as M}from"./chunk-C3VOZNN7.js";import{a as D}from"./chunk-AWBXYETS.js";import{d as P}from"./chunk-QNCAHXZN.js";import{$a as h,Ea as x,Fb as j,Ga as l,La as c,M as E,Qa as C,R as b,Ua as S,Y as p,Z as f,_b as y,bc as A,db as a,eb as n,fb as d,gb as w,hb as _,ib as I,kb as g,lb as m,qb as T,rb as o,tb as v,vb as U}from"./chunk-GBA5LKQX.js";import"./chunk-EQDQRRRY.js";var u=class r{constructor(t){this.http=t}apiUrl="/api/users";changePassword(t){return this.http.put(`${this.apiUrl}/change-password`,t)}static \u0275fac=function(e){return new(e||r)(b(P))};static \u0275prov=E({token:r,factory:r.\u0275fac,providedIn:"root"})};function k(r,t){if(r&1){let e=I();w(0),a(1,"h2",3),o(2,"Carnet Estudiantil"),n(),a(3,"div",4),d(4,"img",5),n(),a(5,"div",4)(6,"label",6),o(7,"Actualizar foto del carnet:"),n(),d(8,"br"),a(9,"input",7),g("change",function(s){p(e);let N=m();return f(N.onFotoChange(s))}),n()(),a(10,"div",4)(11,"strong"),o(12,"Nombre:"),n(),o(13),d(14,"br"),a(15,"strong"),o(16,"C\xE9dula:"),n(),o(17),d(18,"br"),a(19,"strong"),o(20,"Secci\xF3n:"),n(),o(21),n(),a(22,"button",8),g("click",function(){p(e);let s=m();return f(s.onGenerarCarnet())}),d(23,"i",9),o(24," Descargar carnet (JPG) "),n(),_()}if(r&2){let e=m();l(4),h("src",e.fotoUrl,x),l(9),U(" ",e.estudiante.nombre," ",e.estudiante.apellido1," ",e.estudiante.apellido2,""),l(4),v(" ",e.estudiante.cedula,""),l(4),v(" ",e.estudiante.seccion," ")}}function L(r,t){r&1&&(a(0,"div",10),o(1,"No se pudo cargar los datos del estudiante. Por favor, contacte a la administraci\xF3n."),n())}var R=class r{constructor(t,e,i){this.authService=t;this.estudianteService=e;this.userService=i}fotoUrl="";isStudent=!1;isAdmin=!1;estudiante=null;mensaje="";resetMensaje="";onResetPassword(){if(!this.estudiante)return;let t=this.estudiante.cedula,e=this.estudiante.fechaNacimiento;this.userService.changePassword({username:t,oldPassword:"",newPassword:e}).subscribe({next:()=>{this.resetMensaje="Contrase\xF1a restablecida a la fecha de nacimiento."},error:i=>{this.resetMensaje="No se pudo restablecer la contrase\xF1a."}})}ngOnInit(){if(this.isStudent=this.authService.hasRole("ROLE_STUDENT"),this.isAdmin=this.authService.hasRole("ROLE_ADMIN"),this.isStudent){let t=this.authService.getUsernameValue();t&&this.estudianteService.getByCedula(t).subscribe({next:e=>{this.estudiante=e,this.fotoUrl=e?.foto||""},error:()=>{this.mensaje="No se pudo cargar el estudiante."}})}}onFotoChange(t){let e=t.target;if(e.files&&e.files[0]&&this.estudiante?.id){let i=new FileReader;i.onload=s=>{this.fotoUrl=s.target.result,this.estudianteService.updateFoto(this.estudiante.id,this.fotoUrl).subscribe({next:()=>{this.mensaje="Foto actualizada correctamente."},error:()=>{this.mensaje="Error al guardar la foto."}})},i.readAsDataURL(e.files[0])}}onGenerarCarnet(){if(!this.estudiante)return;let t=document.createElement("canvas");t.width=600,t.height=350;let e=t.getContext("2d");if(e)if(e.fillStyle="#fffbe6",e.fillRect(0,0,t.width,t.height),this.fotoUrl){let i=new window.Image;i.onload=()=>{e.drawImage(i,30,40,120,160),this.drawTextAndDownload(e,t)},i.src=this.fotoUrl}else this.drawTextAndDownload(e,t)}drawTextAndDownload(t,e){if(!this.estudiante)return;t.font="bold 28px Arial",t.fillStyle="#333",t.fillText("Carnet Estudiantil",180,60),t.font="20px Arial",t.fillText("Nombre:",180,110),t.fillText(this.estudiante.nombre+" "+this.estudiante.apellido1+" "+this.estudiante.apellido2,270,110),t.fillText("C\xE9dula:",180,150),t.fillText(this.estudiante.cedula,270,150),t.fillText("Secci\xF3n:",180,190),t.fillText(this.estudiante.seccion,270,190);let i=document.createElement("a");i.download="carnet-estudiante.jpg",i.href=e.toDataURL("image/jpeg",.95),i.click()}static \u0275fac=function(e){return new(e||r)(c(D),c(M),c(u))};static \u0275cmp=C({type:r,selectors:[["app-estudiante-edit"]],decls:4,vars:2,consts:[["errorBlock",""],[1,"container","py-5","text-center"],[4,"ngIf","ngIfElse"],[1,"mb-4"],[1,"mb-3"],["alt","Foto estudiante","width","120","height","120",1,"rounded","mb-2",3,"src"],["for","photo"],["type","file","id","photo","accept","image/*","capture","environment",3,"change"],[1,"btn","btn-warning","btn-lg","fw-bold",3,"click"],[1,"bi","bi-person-badge"],[1,"alert","alert-danger","mt-5"]],template:function(e,i){if(e&1&&(a(0,"div",1),S(1,k,25,6,"ng-container",2)(2,L,2,0,"ng-template",null,0,j),n()),e&2){let s=T(3);l(),h("ngIf",i.estudiante)("ngIfElse",s)}},dependencies:[A,y],styles:[".container[_ngcontent-%COMP%]{max-width:500px;margin:auto}img[_ngcontent-%COMP%]{border:2px solid #ccc}.btn-warning[_ngcontent-%COMP%]{background:linear-gradient(90deg,gold,#ffb300);border:none;color:#333}"]})};export{R as EstudianteEditComponent};
